<html>
<head>
    <title>Терминал TradeSharp - Интеграция с МТ4</title>
    <link rel="stylesheet" type="text/css" href="styles.css" />
</head>

<body>
    <img src="picts\main_logo.png" />
    <h1>Интеграция с МТ4</h1>
    <p>
        Терминал TradeSharp может использоваться для управления торговым счетом 
        <a href="http://www.metaquotes.net/ru/metatrader4">МetaТrader 4</a>. Сделки, совершаемые
        в терминале TradeSharp, будут транслированы в терминал MT4. Для этого оба торговых терминала должны быть
        запущены, в каждом из них должна быть выполнена авторизация и установлено соединение с сервером.
    </p>
    <p>
        Торговый счет в терминале Meta Trader 4 может быть открыт у любого брокера / дилингового центра,
        допускающего автоматическую торговлю. Технически, в терминале MT4 торговлю осуществляет
        <a href="http://www.metaquotes.net/ru/metatrader4/automated_trading">эксперт</a> (робот).
    </p>
    <p>
        Аналогично, в терминале TradeSharp, торговый робот отслеживает торговые ордера и в реальном времени
        транслирует их в MetaTrader 4. Обратите внимание на следующие <b>особенности</b>
        исполнения ордеров:
    </p>
    
    <ul>
        <li>Транслируются открытия и закрытия позиций Trade Sharp. Ордера TakeProfit / StopLoss не передаются.</li>
        <li>Терминалы TradeSharp / MT4 могут быть установлены на разных ПК. В этом случае компьютеры должны
            быть связаны локальной сетью либо виртуальным соединением (VPN).</li>
        <li>Если один из терминалов отключен / не авторизован / не имеет установленного соединения
            с сервером, трансляция торговых ордеров в это время не производится.</li>
        <li>После установления связи автоматически будет произведено закрытие ордеров MetaTrader 4,
            в случае если они были ранее закрыты в терминале TradeSharp.</li>
    </ul>

    <h2>Money Management</h2>
    <p>
        При трансляции ордеров в терминал Meta Trader 4 объемы сделок масштабируются относительно
        текущего баланса (средств) счета. Пример:<br />
        <b>TRADE SHARP</b><br />
        Текущий баланс счета: 245 102 USD. <br />
        Выполняется вход в рынок: BUY 80 000 EURUSD. <br />
        <b>METATRADER 4</b><br />
        Текущий баланс счета: 9 987 USD. <br />
        Объем входа будет равен 80 000 x 9 987 / 245 102 = 3 260 USD. <br />
        Эксперт (робот), исполняющий ордер на стороне MetaTrader 4 округлит объем сделки в соответствии с
        объемом лота, минимальным лотом и шагом лота. Допустим, <br />
        объем лота MT4 равен 100 000 ед. базовой валюты,<br />
        минимальный лот равен 0.01, шаг - 0.01.<br />
        Откроется ордер BUY 3 000 EURUSD (100 000 x (0.01 + 0.01 x 2)).
    </p>
    <a name="mt4volume"></a>
    <p>
        В зависимости от установок конкретного брокера объемы, определяемые автоматически, будут недостаточны 
        для входа в рынок. В приведенном примере позиция не была бы открыта в случае, если минимальный лот
        равен не 0.01, а 0.1 или более. В таком случае, в настройках робота TradeSharp можно
        указать больший множитель для объема транслируемых сделок, изначально установленный равным 100%.
    </p>

    <h2>Порядок действий</h2>
    <h3>METATRADER 4</h3>
    <p>
        В корневом каталоге терминала TradeSharp, подкаталоге MT4, найти файл UdpCommandTranslator.mq4
        и скопировать его в подкаталог experts каталога MetaTrader 4.<br />
        В корневом каталоге терминала TradeSharp, подкаталоге MT4, найти файл UdpQueueLib.dll
        и скопировать его в подкаталог experts\libraries каталога MetaTrader 4.<br />
        Запустить терминал MetaTrader 4 (перезапустить, если терминал был уже запущен).
    </p>
    
    <img src="picts\tutorial\mt4\mt4_navi.png" />
    <p class="pictitle">Рис. 1 Эксперты терминала MetaTrader 4</p>
 
    <p>
        В окне "Навигатор" раскрыть группу "Советники" и перетащить "UdpCommandTranslator" на 
        график <b>любого</b> торгуемого инструмента. Данное действие проделывается единожды:
        при попытке установить советник на несколько графиков (в чем нет необходимости для торговли
        любым из доступных активов) возникнет <b>ошибка</b>.
    </p>    

    <p>
        Откроется окно настроек советника. В окне, на первой вкладке (Общие) необходимо установить
        следующие опции:
    </p>
    
    <img src="picts\tutorial\mt4\mt4_page1.png" />
    <p class="pictitle">Рис. 2 Настройки эксперта MetaTrader 4</p>

    <ul>
        <li>Разрешать советнику торговать: да</li>
        <li>Ручное подтверждение: нет</li>
        <li>Разрешить импорт функций из dll: да</li>
        <li>Ручное подтверждение вызовов: нет</li>
    </ul>

    <p>
        На вкладке "Входные параметры" в большинстве настройки не требуют изменений. Внесение
        изменений может потребоваться в случае если терминалы Trade Sharp / Meta Trader 4 установлены
        на разных ПК либо используемые порты заблокированы из соображений безопасности / заняты другим ПО.
        Назначение параметров:
    </p>
    
    <a name="mt4expertsets" />
    <ul>
        <li><b>address:</b> сетевой (IP) адрес ПК, на котором установлен терминал Trade Sharp.
            По-умолчанию - локальный адрес (адрес того же компьютера), 127.0.0.1</li>
        <li><b>portOwn:</b> порт, который прослушивает эксперт UdpCommandTranslator</li>
        <li><b>portTs:</b> порт, который прослушивает робот Trade Sharp</li>
        <li><b>sleepMilliseconds:</b> интервал опроса очереди команд Trade Sharp, служебный параметр</li>
        <li><b>slippage:</b> допустимое проскальзывание, пунктов</li>
    </ul>

    <p>
        Нажмите ОК. Включите торговлю советников кнопкой "Советники" на инструментальной панели терминала 
        MetaTrader4:
    </p>
    <img src="picts\tutorial\mt4\mt4_page2.png" />
    <p class="pictitle">Рис. 3 Включение эксперта MetaTrader 4</p>

    <p>
        Убедитесь, что советник "улыбается" на графике. Возможно предупреждение со стороны
        брандмауэра Windows либо другого антивирусного ПО - разрешите программе доступ к сети.
        На вкладке "Эксперты" окна "Терминал" (внизу окна MetaTrader) найдите записи <br />
        UdpCommandTranslator EURUSD,H4: initialized<br />
        UdpCommandTranslator EURUSD,H4: Started listening<br />
        UdpCommandTranslator EURUSD,H4 inputs: address="127.0.0.1"; portOwn=8011; portTs=8010; slipMilliseconds=300; slippage=6;<br />
        UdpCommandTranslator EURUSD,H4: loaded successfully<br />
    </p>

    <h3>TRADE SHARP</h3>
    <p>
        В торговом терминале Trade Sharp откройте окно настройки роботов: меню Торговля - Роботы.<br />
        Выберите робота "MT4 транслятор".
    </p>

    <a name="tsrobotsets" />
    <img src="picts\tutorial\mt4\ts_portfolio.png" />
    <p class="pictitle">Рис. 4 Портфель роботов</p>

    <p>
        Добавьте робота в портфель. Дважды кликните по названию робота в окне справа и укажите следующие параметры:
        <br />
        <a href="#mt4volume">Объем сделки</a> - по-умолчанию - 100%. На данный коэффициент умножается объем сделки, передаваемой в MetaTrader 4.
        <br />
        <b>Используемые графики</b> - параметр должен быть задан со ссылкой на котируемый инструмент и произвольный таймфрейм.        
        <br />
        <b>Адрес комп. МТ4, Порт (МТ4), Порт (свой)</b> - аналогичны <a href="#mt4expertsets">настройкам советника MetaTrader 4</a>.
    </p>

    <img src="picts\tutorial\mt4\ts_timeframe.png" />
    <p class="pictitle">Рис. 5 Настройка робота - графики</p>

    <p>
        Робот не привязан к инструменту / таймфрейму, как и советник MetaTrader 4, однако эта настройка необходима для его функционирования.
        <br />
        Нажмите "Принять" (предварительно настройки портфеля роботов можно сохранить) и инициируйте исполнение роботов кнопкой инструментальной
        панели терминала:
    </p>

    <a name="tsbuttonrobots" />
    <img src="picts\tutorial\mt4\ts_button_robots.png" />
    <p class="pictitle">Рис. 6 Включение / выключение портфеля роботов</p>

    <h2>Трансляция ордеров</h2>
    <p>
        После того, как проделаны все шаги по настройке MetaTrader 4 - TradeSharp, проконтролируйте трансляцию торговых ордеров:
        это можно сделать на вкладке "Эксперты" MetaTrader 4. Возможные причины, по которым ордер не может быть исполнен, и способы
        их устранения приведены ниже.
    </p>

    <p style="color:#550000">Сделка открылась в TradeSharp, но не была продублирована в MetaTrader 4:</p>
    <ol>
        <li>Возможно, портфель роботов неверно сконфигурирован либо старт роботов не произведен. Проверьте настройки
        TradeSharp (выше), убедитесь, что пиктограмма кнопки запуска роботов имеет вид: 
        <a href="#tsbuttonrobots"><img src="picts\tutorial\mt4\ts_button_pause.png" /></a></li>
        <li>
            Проверьте, не содержит ли окно терминала TradeSharp запись вида:
            <code>[09 апр 10:45] Открытие 1 сделок(сделки) отменяется: нет данных о средствах в MT4</code>
        </li>
        <li>
            Проверьте настройки MetaTrader 4: должно быть установлено соединение с сервером и произведена авторизация,
            советник "UpdCommandTranslator" должен быть размещен на графике ("улыбающаяся" пиктограмма).
        </li>
        <li>
            На вкладке "Эксперты" MetaTrader 4 должна быть запись вида <code>UdpCommandTranslator EURUSD,Daily: initialized</code>.
        </li>
        <li>
            На той же вкладке в момент получения торгового ордера должна быть запись вида
            <code>UdpCommandTranslator EURUSD,Daily: BUY_408_EURUSD_4143</code>
        </li>
        <li>
            Не должно быть отметки вида <code>UdpCommandTranslator EURUSD,Daily: invalid lots amount for OrderSend function</code>
        </li>
    </ol>

    <p>
        Ошибки <b>(2, 4, 5)</b> может быть следствием проблем в работе советника MetaTrader 4. Также ошибка может появиться вследствие
        проблем, связанных с информационным обменом между терминалами. Возможные способы разрешения:<br />
        - сконфигурировать либо временно отключить антивирусное ПО, препятствующее информационному обмену,<br />
        - указать другие порты в настройках 
        <a href="#mt4expertsets">советника MetaTrader 4</a>
        и <a href="#tsrobotsets">робота TradeSharp</a>.
    </p>
    <p>
        Появление ошибки <b>(6)</b> свидетельствует о недостаточном балансе счета MetaTrader 4 для совершения торговой операции
        с тем же плечом, что и в терминале TradeSharp. Обратите внимание на предыдущую запись вида
        <code>BUY_408_EURUSD_4143</code>: здесь первая цифра (408) равна объему входа до округления (объем лота, минимальный лот, шаг лота).
        Если ваши правила риск менеджмента позволяют это, попробуйте увеличить объем входа:<br />
        - в терминале TradeSharp при открытии сделки либо <br />
        - в настройках робота "MT4 транслятор", параметр <b>Объем сделки</b>.
    </p>

    <p style="color:#550000">Сделка закрылась в TradeSharp, но не была закрыта в MetaTrader 4:</p>
    <p>
        Аналогично открытию сделки. Дополнительно, проверьте наличие во вкладке "Эксперты" терминала MetaTrader 4
        записей вида:
    </p>
    <ol>
        <li>UdpCommandTranslator EURUSD,Daily: Close pos with magic 4143</li>
        <li>UdpCommandTranslator EURUSD,Daily: CLOS_4143</li>
    </ol>

    <p>
        Отсутствие записей - аналогично п. 4 (открытие сделки). Если отсутствует только запись вида 
        <code>Close pos with magic ...</code> (запись вида <code>CLOS_...</code> присутствует) - сделка,
        которая была закрыта в терминале TradeSharp не была открыта в терминале MetaTrader 4 либо к тому 
        времени уже была закрыта.
    </p>

    <p>
        Если в терминале TradeSharp были закрыты какие-либо сделки из числа тех, что транслировались в MetaTrader 4,
        при установлении информационного обмена между терминалами эти сделки будут немедленно закрыты в терминале MetaTrader 4.
        Если закрытие сделок в терминале MetaTrader 4 временно невозможно (нет цены, нет связи с сервером, выходной день...)
        сделки будут закрыты в тот момент, когда это будет возможно (при условии, что связь между терминалами установлена).
    </p>
</body>
</html>